#!/usr/bin/env python3
"""
Helper Script - D√©ploiement du Mod√®le
Automatise la conversion et la v√©rification du mod√®le
"""

import os
import sys
import subprocess
import json
from pathlib import Path

def check_prerequisites():
    """V√©rifie les pr√©requis install√©s"""
    print("üîç V√©rification des pr√©requis...\n")
    
    # V√©rifier Python
    try:
        result = subprocess.run([sys.executable, '--version'], capture_output=True, text=True)
        print(f"‚úÖ Python: {result.stdout.strip()}")
    except Exception as e:
        print(f"‚ùå Python: {e}")
        return False
    
    # V√©rifier pip
    try:
        result = subprocess.run([sys.executable, '-m', 'pip', '--version'], capture_output=True, text=True)
        print(f"‚úÖ pip: {result.stdout.strip()}")
    except Exception as e:
        print(f"‚ùå pip: {e}")
        return False
    
    # V√©rifier TensorFlow
    try:
        result = subprocess.run([sys.executable, '-c', 'import tensorflow; print(tensorflow.__version__)'], 
                              capture_output=True, text=True)
        print(f"‚úÖ TensorFlow: {result.stdout.strip()}")
    except Exception as e:
        print(f"‚ö†Ô∏è  TensorFlow non install√©. Installation requise.")
        return False
    
    print()
    return True

def install_requirements():
    """Installe les d√©pendances n√©cessaires"""
    print("üì¶ Installation des d√©pendances...\n")
    
    packages = ['tensorflow', 'tensorflowjs']
    
    for package in packages:
        print(f"   ‚¨áÔ∏è  Installation de {package}...")
        try:
            subprocess.run(
                [sys.executable, '-m', 'pip', 'install', '--upgrade', package],
                check=True,
                capture_output=True
            )
            print(f"   ‚úÖ {package} install√©")
        except subprocess.CalledProcessError as e:
            print(f"   ‚ùå Erreur: {e}")
            return False
    
    print()
    return True

def verify_model_file(h5_path):
    """V√©rifie que le fichier mod√®le existe"""
    if not os.path.exists(h5_path):
        print(f"‚ùå Erreur: Fichier {h5_path} introuvable")
        print(f"\nüìÅ Fichiers .h5 trouv√©s:")
        for file in Path('.').glob('*.h5'):
            print(f"   - {file}")
        return False
    
    file_size = os.path.getsize(h5_path) / (1024 * 1024)
    print(f"‚úÖ Mod√®le trouv√©: {h5_path} ({file_size:.2f} MB)")
    return True

def verify_output_dir(output_dir):
    """Cr√©e et v√©rifie le r√©pertoire de sortie"""
    os.makedirs(output_dir, exist_ok=True)
    print(f"‚úÖ R√©pertoire de sortie: {output_dir}")
    return True

def convert_model(h5_path, output_dir):
    """Convertit le mod√®le .h5 en TensorFlow.js"""
    print(f"\nüì¶ Conversion du mod√®le...\n")
    print(f"   Input:  {h5_path}")
    print(f"   Output: {output_dir}\n")
    
    cmd = [
        sys.executable, '-m', 'tensorflowjs.converters.convert_tf_saved_model' 
        if h5_path.endswith('_saved_model') else 'tensorflowjs_converter',
        '--input_format', 'keras',
        h5_path,
        output_dir
    ]
    
    # Utiliser tensorflowjs_converter directement
    cmd = [
        'tensorflowjs_converter',
        '--input_format', 'keras',
        h5_path,
        output_dir
    ]
    
    print(f"‚öôÔ∏è  Ex√©cution: {' '.join(cmd)}\n")
    
    try:
        result = subprocess.run(cmd, check=True, capture_output=False, text=True)
        return True
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Erreur conversion: {e}")
        return False
    except FileNotFoundError:
        print(f"‚ùå tensorflowjs_converter non trouv√©")
        print(f"   Installation: pip install tensorflowjs")
        return False

def verify_output_files(output_dir):
    """V√©rifie les fichiers de sortie"""
    print(f"\n‚úÖ V√©rification des fichiers g√©n√©r√©s...\n")
    
    required_files = ['model.json', 'model.weights.bin']
    
    for file in required_files:
        file_path = os.path.join(output_dir, file)
        if os.path.exists(file_path):
            size = os.path.getsize(file_path) / (1024 * 1024)
            print(f"   ‚úÖ {file} ({size:.2f} MB)")
        else:
            print(f"   ‚ùå {file} (NOT FOUND)")
            return False
    
    # V√©rifier le contenu de model.json
    model_json_path = os.path.join(output_dir, 'model.json')
    try:
        with open(model_json_path, 'r') as f:
            model_config = json.load(f)
            print(f"\nüìä Informations du mod√®le:")
            print(f"   Format: {model_config.get('format', 'N/A')}")
            print(f"   Generated by: {model_config.get('generatedBy', 'N/A')}")
    except Exception as e:
        print(f"   ‚ö†Ô∏è  Impossible de lire model.json: {e}")
    
    return True

def main():
    print("=" * 60)
    print("üöÄ Helper - D√©ploiement du Mod√®le de Reconnaissance Faciale")
    print("=" * 60)
    print()
    
    # Param√®tres
    h5_file = 'face_recognition_model.h5'
    output_dir = './assets/models'
    
    # √âtape 1: V√©rifier les pr√©requis
    if not check_prerequisites():
        print("‚ö†Ô∏è  Certains pr√©requis manquent")
        print("\nüì• Installation automatique...\n")
        if not install_requirements():
            print("‚ùå Impossible d'installer les d√©pendances")
            sys.exit(1)
    
    # √âtape 2: V√©rifier le fichier mod√®le
    if not verify_model_file(h5_file):
        print("\nüí° Aide:")
        print("   1. T√©l√©chargez le mod√®le depuis Google Colab")
        print("   2. Placez le fichier .h5 dans le r√©pertoire racine")
        print("   3. Relancez ce script")
        sys.exit(1)
    
    # √âtape 3: Pr√©parer le r√©pertoire de sortie
    if not verify_output_dir(output_dir):
        sys.exit(1)
    
    # √âtape 4: Convertir le mod√®le
    if not convert_model(h5_file, output_dir):
        sys.exit(1)
    
    # √âtape 5: V√©rifier les fichiers g√©n√©r√©s
    if not verify_output_files(output_dir):
        sys.exit(1)
    
    print("\n" + "=" * 60)
    print("‚úÖ D√©ploiement termin√© avec succ√®s!")
    print("=" * 60)
    print("\nüìù Prochaines √©tapes:")
    print("   1. Ex√©cutez: npm install")
    print("   2. Ex√©cutez: npm run android (ou ios/web)")
    print("   3. Testez la reconnaissance faciale dans l'application")
    print()

if __name__ == '__main__':
    main()
