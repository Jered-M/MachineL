#!/usr/bin/env python3
"""
Convertir face.h5 en format TensorFlow.js
"""
import os
import sys
import json

try:
    from tensorflow import keras
    import tensorflowjs as tfjs
except ImportError as e:
    print(f"‚ùå Erreur d'import: {e}")
    print("Installez les d√©pendances: pip install tensorflow tensorflowjs")
    sys.exit(1)

def convert_model():
    """Convertir le mod√®le Keras en TensorFlow.js"""
    
    # Chemins
    model_path = './face.h5'
    output_dir = './assets/models/tfjs_model'
    
    print(f"üì¶ Chargement du mod√®le: {model_path}")
    
    # V√©rifier que le fichier existe
    if not os.path.exists(model_path):
        print(f"‚ùå Fichier non trouv√©: {model_path}")
        return False
    
    try:
        # Charger le mod√®le Keras
        model = keras.models.load_model(model_path)
        print(f"‚úÖ Mod√®le charg√©")
        print(f"üìä Architecture:")
        model.summary()
        
        # Cr√©er le r√©pertoire de sortie
        os.makedirs(output_dir, exist_ok=True)
        print(f"üìÅ R√©pertoire de sortie: {output_dir}")
        
        # Convertir en TensorFlow.js
        print(f"üîÑ Conversion en TensorFlow.js...")
        tfjs.converters.save_keras_model(model, output_dir)
        print(f"‚úÖ Conversion termin√©e!")
        
        # V√©rifier les fichiers cr√©√©s
        files = os.listdir(output_dir)
        print(f"üìÑ Fichiers cr√©√©s:")
        for f in files:
            size = os.path.getsize(os.path.join(output_dir, f))
            print(f"  - {f} ({size} bytes)")
        
        # Lire et afficher le model.json
        model_json_path = os.path.join(output_dir, 'model.json')
        if os.path.exists(model_json_path):
            with open(model_json_path, 'r') as f:
                model_info = json.load(f)
            print(f"\nüìã Model.json info:")
            print(f"  Format: {model_info.get('format')}")
            print(f"  Generated by: {model_info.get('generatedBy')}")
            if 'modelTopology' in model_info:
                print(f"  Topology: {model_info['modelTopology']['class_name']}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur lors de la conversion: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == '__main__':
    success = convert_model()
    sys.exit(0 if success else 1)
